var deviceWidth=document.documentElement.clientWidth;if(deviceWidth>750){deviceWidth=750;}document.documentElement.style.fontSize=deviceWidth/10.8+"px";
var $mapWrap=$("#mapWrap");window.$mapWrap=$mapWrap;var $searchSort=$("#searchSort");window.$searchSort=$searchSort;bmapInit();$("body").on("click",".iconBack",function(a){a.stopPropagation();
var b=$(this).parents(".secondWrap,.resultWrap");b.animate({left:"100%"},function(){if(b.hasClass("resultWrap")){b.hide();}else{b.remove();}});});var flag=false;
$("body").on("click","#chooseKmButton",function(){if(!flag){$(this).parents(".chooseDistance").children(".chooseKm").show();flag=true;}else{$(this).parents(".chooseDistance").children(".chooseKm").hide();
flag=false;}});function bmapInit(){var b=new BMap.Map("allmap");b.addControl(new BMap.MapTypeControl());b.enableScrollWheelZoom(true);b.centerAndZoom("上海",15);
window.map=b;var a=new BMap.Geolocation();window.geolocation=a;a.getCurrentPosition(function(d){if(this.getStatus()==BMAP_STATUS_SUCCESS){var c=new BMap.Marker(d.point);
b.addOverlay(c);b.panTo(d.point);}else{}},{enableHighAccuracy:true});}document.onkeydown=function(b){var a=document.all?window.event:b;if(a.keyCode==13){initSearch();
}};$("body").on("click","#chooseKm span",function(){var b=$(this).text();var a=$(this).attr("data");$("#kmsum").text(b).attr("data",a);$(this).parent("#chooseKm").hide();
initSearch();flag=false;});function initSearch(){var b=$("#mapSearchText").val();var a="r-result";var c=$("#kmsum").attr("data");searchFun(b,a,c);}$("body").on("click","#searchSort > span",function(){$(this).addClass("current").siblings().removeClass("current");
var b=$("#mapSearchText").val();var a="r-result";var d=$("#kmsum").attr("data");var c=$(this).find(".stext").text();searchFun(b,a,d,c);});function searchFun(e,a,b,i){if(e==""||e==null){alert("请输入地址");
}map.clearOverlays();var g=["超市","菜场","批发市场","餐饮企业"];if(i==null){i=g;}var c,f,h;var h=0;var d=new BMap.Geocoder();d.getPoint(e,function(j){if(j){map.centerAndZoom(j,15);
map.addOverlay(new BMap.Marker(j));c=new BMap.Circle(j,b,{fillColor:"blue",strokeWeight:1,fillOpacity:0.3,strokeOpacity:0.3});map.addOverlay(c);f=new BMap.LocalSearch(map,{renderOptions:{map:map,panel:a,autoViewport:false},onSearchComplete:function(o){var m="";
if(i==g){for(var n=0;n<o.length;n++){h+=o[n].getNumPois();}m+='<div class="searchSort" id="searchSort"><span id="marketBtn"><span class="marketSUM">'+o[0].getNumPois()+'</span><span class="stext">超市</span></span><span id="foodmarketBtn"><span class="foodmarketSUM">'+o[1].getNumPois()+'</span><span class="stext">菜场</span></span><span id="wholesalemarketBtn"><span class="wholesalemarketSUM">'+o[2].getNumPois()+'</span><span class="stext">批发市场</span></span><span id="cateringbusinessBtn"><span class="cateringbusinessSUM">'+o[3].getNumPois()+'</span><span class="stext">餐饮企业</span></span></div>';
if($searchSort.length>=1){$searchSort.remove();}$mapWrap.append(m);$("#mapserachResultSum").html('<span>共有</span><span class="mapSearchSum">'+h+"</span><span>个节点</span>");
}else{h=o.getNumPois();$("#mapserachResultSum").html('<span>已选</span><span class="mapSearchSum">'+h+'</span><span>个节点</span> <span class="iconfont icon-liebiao" id="showDetailList"></span>');
}},pageCapacity:10});f.searchNearby(i,j,1000);var l="";l+='<div class="traceList" id="traceList"><h1>可追溯的商品</h1><span class="traceBox"><span class="tracepro"><a>雨润猪肉</a><a>精气神猪肉</a><a>双汇猪肉</a><a>牛肉</a><a>鸡肉</a><a>双汇猪肉</a><a>雨润猪肉</a><a>精气神猪肉</a><a>双汇猪肉</a><a>牛肉</a><a>鸡肉</a><a>双汇猪肉</a></span></span></div>';
var k=$("#traceList");if(k.length>=1){k.remove();}$mapWrap.append(l);}else{alert("您选择地址没有解析到结果!");}},"上海市");}$("body").on("click","#showDetailList",function(){$("#r-result").parents(".resultWrap").show().animate({left:"0"});
});$("body").on("click","#r-result li",function(){var c="超市";var a="大道";var e="1km";var d="";d+='<div class="searchListHead"><span class="iconfont icon-jiantouBack iconBack"></span><div class="headlist" id="head-searchThumb"><span class="headName">'+c+'</span><span class="headAddress">'+a+'</span><span class="headtance"><span class="iconfont icon-iconfontluxiandaohang"></span> <label class="headDistance">'+e+"</label></span></div></div>";
var b='<div class="searchListBody" id="searchThumbBox"><ul class="searchThumblist" id="searchThumblist"></ul></div>';$mapWrap.append('<div class="secondWrap" id="searchThumbBox"></div>');
$("#searchThumbBox").animate({left:"0"}).html(d+b);$.getJSON("json/searchThumb.json",function(h){var g="";for(var f=0;f<h.length;f++){g+='<li><a><img class="thumbimg" src="'+h[f].img+'"><p class="thumbname">'+h[f].name+'</p><p class="thumbcodename">'+h[f].tcodename+'</p><p class="thumbcode">'+h[f].tcode+'</p><p class="thumbline"><span class="iconfont icon-dao"></span><span class="iconfont icon-car2"></span><span class="iconfont icon-fangziall"></span><span class="iconfont icon-gouwuche"></span></p></li></a>';
}$("#searchThumblist").html(g);});});$("body").on("click","#searchThumblist a",function(){var f=$(this).find(".thumbimg").attr("src");var a=$(this).find(".thumbname").text();
var d=$(this).find(".thumbcodename").text();var j=$(this).find(".thumbcode").text();var b=$(this).parents(".secondWrap").find(".headName").text();var c=$(this).parents(".secondWrap").find(".headAddress").text();
var e=$(this).parents(".secondWrap").find(".headDistance").text();var i="";i+='<div class="searchListHead"><span class="iconfont icon-jiantouBack iconBack"></span><div class="headlist" id="head-searchThumb"><span class="headName">'+b+'</span><span class="headAddress">'+c+'</span><span class="headtance"><span class="iconfont icon-iconfontluxiandaohang"></span> <label class="headDistance">'+e+"</label></span></div></div>";
var h='<div class="searchListBody" id="searchThumblistBox"></div>';$mapWrap.append('<div class="secondWrap" id="searchThumbDetailBox"></div>');$("#searchThumbDetailBox").animate({left:"0"}).html(i+h);
var g="";g+='<img class="tImg" src="'+f+'"><p class="tName">'+a+'</p><p class="tCodeName"><label>'+d+'：</lable><span class="tCode">'+j+'</span></p><div class="tLine"><div class="tLineTool clearfix"><span class="iconfont icon-dao"></span><div class="tooltipsbox"><h1>屠宰</h1><p>建东屠宰场</p><span>2017-05-05 00:28</span></div></div><div class="tLineTool clearfix"><span class="iconfont icon-car2"></span><div class="tooltipsbox"><h1>屠宰</h1><p>建东屠宰场</p><span>2017-05-05 00:28</span></div></div><div class="tLineTool clearfix"><span class="iconfont icon-fangziall"></span><div class="tooltipsbox"><h1>屠宰</h1><p>建东屠宰场</p><span>2017-05-05 00:28</span></div></div><div class="tLineTool clearfix"><span class="iconfont icon-gouwuche"></span><div class="tooltipsbox"><h1>屠宰</h1><p>建东屠宰场</p><span>2017-05-05 00:28</span></div></div></div>';
$("#searchThumblistBox").html(g);});$("body").on("click","#headList li",function(){var b=$(this).children(".iconfont");var c=$(this);var a=$(this).parents(".resultWrap");
c.addClass("current").siblings().removeClass("current");if(b.hasClass("icon-kongdown")){b.addClass("icon-kongup").removeClass("icon-kongdown");c.siblings().children(".iconfont").removeClass("icon-kongup").addClass("icon-kongdown");
c.parents(".searchListHead").children("#categoriesBox").show();if(a.find(".fixed").length>=1){a.find(".fixed").remove();}a.append('<div class="fixed"></div>');
}else{b.addClass("icon-kongdown").removeClass("icon-kongup");c.parents(".searchListHead").children("#categoriesBox").hide();a.find(".fixed").remove();}});
$("body").on("click","#categoriesList > span",function(){$(this).addClass("current").siblings().removeClass("current");});