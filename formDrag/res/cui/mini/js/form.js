/*! cui 2016-11-08 */
$.component("coral.form",{version:"4.0.2",options:{disabled:null,ajaxSubmit:!0,novalidate:!1,context:"",separator:",",container:"tooltip",requires:null,excluded:[":disabled",":hidden",":not(:visible)"],errTipsType:"first",onCreate:null,url:"",postData:{},target:"",focusFirst:!1,showRequiredMark:null,hideRequiredMark:null,onChange:null,triggers:{},exclude:!1},_create:function(){this._initElement(),this._bindEvents(),$.data(this.element,"modifiedData",{}),$.data(this.element,"originalData",this._getForm()),this.element.validate({excluded:this.options.excluded,errorMode:this.options.errorMode,showRequiredMark:this.options.showRequiredMark,hideRequiredMark:this.options.hideRequiredMark}),this.options.focusFirst&&this._focusFirst(),this.element.append($("<input type='text' style='display:none;'></input>"))},_getFields:function(){return this.element.find(".ctrl-form-element")},_getFieldType:function(a){var b=$(a)[0].className.split(" "),c="";for(var d in b)if(b[d].indexOf("coral-validation-")>=0)return c=b[d].substr(b[d].indexOf("coral-validation-")+17);return null},_bindEvents:function(){var a=this,b=(this.options,this._getFields());b.each(function(b,c){var d=$(c),e=a._getFieldType(d);d.off(".formonchange").on(e+"onchange.formonchange",function(b,c){if(-1!=b.type.indexOf("onchange")){var d=$(this)[e]("option","name"),f=$(this)[e]("getValue"),g={};g[d]=f,a.updateCoralData(g),a._trigger("onChange",null,{field:this,type:e})}})})},_initElement:function(){var a=this.options;this.element.addClass(a.cls),this.element.appendTo(this.uiBorder),this.element.addClass("coral-form-default"),""!==a.id&&this.element.attr("id",a.id),""!==a.name&&this.element.attr("name",a.name),""!==a.action&&this.element.attr("action",a.action),""!==a.method&&this.element.attr("method",a.method),""!==a.target&&this.element.attr("target",a.target),""!=a.context?this.element.attr("context",a.context):this.element.attr("context","body")},initRequires:function(){this._initRequires()},_initRequires:function(){var a=this.element.find($("[class*='coral-validation-']")).parent(":visible").find($("[class*='coral-validation-']"));a.each(function(){var a=this.className,b="",c=a.split(" ");for(var d in c)if(c[d].indexOf("coral-validation-")>=0){b=c[d].substr(c[d].indexOf("coral-validation-")+17);break}var e=$(this)[b]("option","required");"boolean"==typeof e&&e&&("datepicker"==b?$(this)[b]("component",$(this)).parent("td").prev().addClass("require"):$(this)[b]("component").parent("td").prev().addClass("require"))})},_getCoralType:function(a){var b=$(a)[0].className.split(" "),c="";for(var d in b)if(b[d].indexOf("coral-validation-")>=0)return c=b[d].substr(b[d].indexOf("coral-validation-")+17)},showRequire:function(a){var b=$(a),c=this._getCoralType(a);b[c]("component").parent("td").prev().addClass("require")},hideRequire:function(a){var b=$(a),c=this._getCoralType(a);b[c]("component").parent("td").prev().removeClass("require")},_setOption:function(a,b){"id"!=a&&"name"!=a&&this._super(a,b)},saveOriginalCoralData:function(a){var b=this;$.each(a,function(a,c){b._updateCoralData("original",a,c)})},updateCoralData:function(a){var b=this;$.each(a,function(a,c){b._updateCoralData("modified",a,c)})},_updateCoralData:function(a,b,c){var d=$.data(this.element,a+"Data");d[b]=c,$.data(this.element,a+"Data",d)},serialize:function(){return $(this.element).serialize()},serializeArray:function(){return $(this.element).serializeArray()},modifiedData:function(a){return"boolean"==typeof a&&a?this._getSerialize("modified"):$.data(this.element,"modifiedData")},originalData:function(a){return"boolean"==typeof a&&a?this._getSerialize("original"):$.data(this.element,"originalData")},formData:function(){return this._getForm()},getData:function(){return this.formData()},_getSerialize:function(a){var b=$.data(this.element,a+"Data"),c="";return $.each(b,function(a,b){if("Object"!=typeof b)c+=a+"="+b+"&";else for(var d in b)c+=a+"="+b[d]+"&"}),c.substr(0,c.length-1)},_getForm:function(){var a=this,b={},c={},d=$(this.element).serializeArray();return $(this.element).find(".ctrl-form-element").each(function(){var c=$(this).attr("component-role"),d=$(this)[c]("option","name");d&&("checkbox"!==c&&"radio"!==c&&b[d]?b[d]=b[d]+a.options.separator+$(this)[c]("getValue"):b[d]=$(this)[c]("getValue"))}),$(d).each(function(d,e){e.name&&"undefined"==typeof b[e.name]&&(c[e.name]?c[e.name]=c[e.name]+a.options.separator+e.value:c[e.name]=e.value)}),$.extend(b,c),b},_loadData:function(a){var b=this;this._updateData(a,"modified"),this._updateData(a,"original"),"object"==typeof a&&$.each(a,function(a,c){b._loadCoralData(a,c)||b._loadNormalData(a,c)})},_loadCoralData:function(a,b){var c=this;b=null==b?"":b;var d=c._getCoralFormData(),e=!1;for(var f in d){var g=d[f],h=g.coralType;switch(h){case"radio":a==g.name&&(e=!0,g.el[h]("option","value")==b&&null!=b?g.el[h]("check"):g.el[h]("uncheck"));break;case"radiolist":a==g.name&&(e=!0,null==b&&(b=""),g.el[h]("setValue",b));break;case"checkbox":if(a==g.name){e=!0,null==b&&(b=[""]),"object"!=typeof b&&(b="string"==typeof b?b.split(c.options.separator):[b]);for(var i in b){if(g.el[h]("option","value")==b[i]){g.el[h]("check");break}g.el[h]("uncheck")}}break;case"checkboxlist":a==g.name&&(e=!0,a==g.name&&(null==b&&(b=""),g.el[h]("setValue",b)));break;case"combobox":case"combotree":case"combogrid":a==g.name&&(e=!0,"object"!=typeof b&&(b="string"==typeof b?b.split(c.options.separator):[b]),null!=b&&g.el[h]("setValues",b));break;case"datepicker":a==g.name&&(e=!0,null!=b&&g.el[h]("option","value",b));break;case"autocomplete":case"autocompletetree":a==g.name&&(e=!0,null!=b&&g.el[h]("option","value",b));break;default:a==g.name&&(e=!0,null!=b&&g.el[h]("option","value",b))}}return e},_loadNormalData:function(a,b){var c=this,d=c._getNomalFormElements();for(var e in d)if(a==d[e].attr("name"))if(void 0!=d[e].attr("type")&&"radio"==d[e].attr("type")){if(b!=d[e].attr("value"))continue;d[e][0].checked=!0}else"string"==typeof b&&-1!=b.indexOf(c.options.separator)&&(b=b.split(c.options.separator)),$(c.element.find("[name="+a+"]")).val(b)},_getAllFromElements:function(){return this.element.find("[name]")},_getCoralFormData:function(){var a=[];return this.element.find(".ctrl-form-element").each(function(){var b=$(this),c=null,d=b.attr("component-role");c=b[d]("option","name"),null!=c&&a.push({el:b,name:c,coralType:d})}),a},_getCoralFormElements:function(){return this.element.find(".coral-form-element")},_getCoralNameJson:function(){var a=this,b={};return a._getCoralFormElements().each(function(){var a=$(this).attr("component-role");$(this)[a]("option","name")&&(b[name]=a)}),b},_getNomalFormElements:function(){var a=this,b=[],c=a._getCoralNameJson();return a._getAllFromElements().each(function(){c[$(this).attr("name")]||b.push($(this))}),b},_updateData:function(a,b){var c=$.data(this.element,b+"Data");"object"==typeof a&&$.each(a,function(a,d){"original"==b&&"undefined"!=typeof c[a]?c[a]=d:"modified"==b&&"undefined"!=typeof c[a]&&delete c[a]})},resetData:function(){this.reset()},getErrors:function(){var a=this.component().find(".coral-validate-error"),b=[];return a.each(function(){var a=$(this).find(".ctrl-form-element"),c=$(a).attr("component-role"),d={};d.errorText=$(this).find(".coral-errorIcon").attr("data-errors"),d.required=$(a)[c]("option","required"),d.id=$(a)[c]("option","id"),d.validType=$(a)[c]("option","validType"),d.value=$(a)[c]("getValue"),d.element=a[0],d.requiredMsg=$(a)[c]("option","requiredMsg")||$.validate.options.requiredMsg,d.name=$(a)[c]("option","name"),b.push(d)}),b},reset:function(){$(this.element).find(".ctrl-form-element").each(function(a){var b=$(this).attr("component-role");$(this)[b]("reset")}),$.data(this.element,"modifiedData",{})},_isExclud:function(a,b){if(!b)return!1;for(var c=b.length,d=0;c>d;d++)if("string"==typeof b[d]&&a.is(b[d]))return!0;return!1},clear:function(a){var b={};if(a&&a.excluded&&a.excluded instanceof Array)for(var c in a.excluded){var d=a.excluded[c];b[d]=d}$(this.element).find(".ctrl-form-element").each(function(a){var c=$(this).attr("component-role");if(!($(this)[c]("option","readonly")&&b.readonly||$(this)[c]("option","isLabel")&&b.isLabel||$(this)[c]("option","disabled")&&b.disabled))switch(c){case"radio":case"checkbox":$(this)[c]("uncheck");break;default:$(this)[c]("setValue","")}}),$.validate.clearErrors(this.element),$.data(this.element,"modifiedData",{})},load:function(a){var b=this,c={},d=[],e=!1;"undefined"!=typeof a&&("string"!=typeof a?(c=a,c.data?d=c.data:c.url?(a=c.url,e=!0):d=a):e=!0,e?$.ajax({url:a,type:"POST",data:$.extend(!0,{},this.options.postData,c.postData),async:!1,dataType:"json",success:function(a){b._loadData(a),b._trigger($.isFunction(c.onLoad)?c.onLoad:"onLoad",null,[a])},error:function(){b._trigger("onLoadError",null,[])}}):(this._loadData(d),this._trigger($.isFunction(c.onLoad)?c.onLoad:"onLoad",null,[{content:d}])))},loadData:function(a){this.load(a)},submit:function(a){if(a=a||{},0==this._trigger($.isFunction(a.onSubmit)?a.onSubmit:"onSubmit",null,[]))return!1;if(this.options.ajaxSubmit)$.ajax({type:"post",url:$.extend(!0,{},this.options.url,a.url),data:$.extend(!0,{},this.options.postData,a.postData,this.formData),dataType:"json",success:function(b){this._trigger($.isFunction(a.onSuccess)?a.onSuccess:"onSuccess",null,[{content:b}])},error:function(){}});else{if(!this.valid())return!1;this.element.submit()}},valid:function(){return this.options.novalidate?!0:this.element.validate("valid")},hideErrorTips:function(){$("div.coral-validate-state-error").remove()},_focusFirst:function(){},findFields:function(){return $.coral.findComponent(".ctrl-form-element",this.element)},setIsLabel:function(a){$.coral.setIsLabel(a,this.element)},setReadOnly:function(a){$.coral.setReadOnly(a,this.element)},refresh:function(a){var b,c=this.options,d=c.heightStyle,e=this.component().parent();"fill"===d?($.coral.fitParent(this.component(),!0),b=e.height(),this.component().siblings(":visible").each(function(){var a=$(this),c=a.css("position");"absolute"!==c&&"fixed"!==c&&(b-=a.outerHeight(!0))}),this.element.height(Math.max(0,b-this.element.innerHeight()+this.element.height())).addClass("coral-scroll")):"auto"===d&&this.element.height(""),$.coral.refreshChild(this.element)}});