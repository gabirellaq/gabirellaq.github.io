/*! cui 2016-11-08 */
function _pivotfilter(a,b){var c,d,e,f=[];if(!this||"function"!=typeof a||a instanceof RegExp)throw new TypeError;for(e=this.length,c=0;e>c;c++)if(this.hasOwnProperty(c)&&(d=this[c],a.call(b,d,c,this))){f.push(d);break}return f}$.assocArraySize=function(a){var b,c=0;for(b in a)a.hasOwnProperty(b)&&c++;return c},$.component("coral.grid",$.coral.grid,{pivotSetup:function(a,b){var c=[],d=this,e=[],f=[],g=[],h=[],i={grouping:!0,groupingView:{groupField:[],groupSummary:[],groupSummaryPos:[]}},j=[],k=$.extend({rowTotals:!1,rowTotalsText:"Total",colTotals:!1,groupSummary:!0,groupSummaryPos:"header",frozenStaticCols:!1},b||{});return this.element.each(function(){function b(a,b,c){var d;return d=_pivotfilter.call(a,b,c),d.length>0?d[0]:null}function l(a,b){var c,e=0,f=!0;for(c in a){if(a[c]!=d[e]){f=!1;break}if(e++,e>=d.length)break}return f&&(q=b),f}function m(a,b,c,d){var e;switch(a){case"sum":e=parseFloat(b||0)+parseFloat(d[c]||0);break;case"count":""!==b&&null!=b||(b=0),e=d.hasOwnProperty(c)?b+1:0;break;case"min":e=""===b||null==b?parseFloat(d[c]||0):Math.min(parseFloat(b),parseFloat(d[c]||0));break;case"max":e=""===b||null==b?parseFloat(d[c]||0):Math.max(parseFloat(b),parseFloat(d[c]||0))}return e}function n(a,b,c,d){var e,f,i,j,k=b.length,l="",n=[];for($.isArray(c)?(j=c.length,n=c):(j=1,n[0]=c),g=[],h=[],g.root=0,i=0;j>i;i++){var o,p=[];for(e=0;k>e;e++){if(null==c)f=$.trim(b[e].member)+"_"+b[e].aggregator,o=f,n[0]=o;else{o=c[i].replace(/\s+/g,"");try{f=1===k?l+o:l+o+"_"+b[e].aggregator+"_"+String(e)}catch(q){}}f=isNaN(parseInt(f,10))?f:f+" ",d[f]=p[f]=m(b[e].aggregator,d[f],b[e].member,a),1>=i&&"_r_Totals"!==o&&""===l&&(l=o)}g[f]=p,h[f]=n[i]}return d}function o(a){var b,d,e,f,g;for(e in a)if(a.hasOwnProperty(e)){if("object"!=typeof a[e]){if("level"===e){if(void 0===K[a.level]&&(K[a.level]="",a.level>0&&"_r_Totals"!==a.text&&(j[a.level-1]={useColSpanStyle:!1,groupHeaders:[]})),K[a.level]!==a.text&&a.children.length&&"_r_Totals"!==a.text&&a.level>0){j[a.level-1].groupHeaders.push({titleText:a.label,numberOfColumns:0});var h=j[a.level-1].groupHeaders.length-1,i=0===h?M:L+u;if(a.level-1===(k.rowTotals?1:0)&&h>0){var l=j[a.level-1].groupHeaders[h-1].numberOfColumns;l&&(i=l+1+k.aggregates.length)}j[a.level-1].groupHeaders[h].startColumnName=c[i].name,j[a.level-1].groupHeaders[h].numberOfColumns=c.length-i,L=c.length}K[a.level]=a.text}if(a.level===t&&"level"===e&&t>0)if(u>1){var m=1;for(b in a.fields)1===m&&j[t-1].groupHeaders.push({startColumnName:b,numberOfColumns:1,titleText:a.text}),m++;j[t-1].groupHeaders[j[t-1].groupHeaders.length-1].numberOfColumns=m-1}else j.splice(t-1,1)}if(null!=a[e]&&"object"==typeof a[e]&&o(a[e]),"level"===e&&a.level>0){d=0;for(b in a.fields)if(a.fields.hasOwnProperty(b)){g={};for(f in k.aggregates[d])if(k.aggregates[d].hasOwnProperty(f))switch(f){case"member":case"label":case"aggregator":break;default:g[f]=k.aggregates[d][f]}u>1?(g.name=b,g.label=k.aggregates[d].label||a.label):(g.name=a.text,g.label="_r_Totals"===a.text?k.rowTotalsText:a.label),c.push(g),d++}}}}var p,q,r,s,t,u,v,w,x=a.length,y=0;if(k.rowTotals&&k.yDimension.length>0){var z=k.yDimension[0].dataName;k.yDimension.splice(0,0,{dataName:z}),k.yDimension[0].converter=function(){return"_r_Totals"}}if(s=$.isArray(k.xDimension)?k.xDimension.length:0,t=k.yDimension.length,u=$.isArray(k.aggregates)?k.aggregates.length:0,0===s||0===u)throw"xDimension or aggregates optiona are not set!";var A;for(r=0;s>r;r++)A={name:k.xDimension[r].dataName,frozen:k.frozenStaticCols},null==k.xDimension[r].isGroupField&&(k.xDimension[r].isGroupField=!0),A=$.extend(!0,A,k.xDimension[r]),c.push(A);for(var B=s-1,C={};x>y;){p=a[y];var D=[],E=[];v={},r=0;do D[r]=$.trim(p[k.xDimension[r].dataName]),v[k.xDimension[r].dataName]=D[r],r++;while(s>r);var F=0;if(q=-1,w=b(e,l,D)){if(q>=0){if(F=0,t>=1){for(F=0;t>F;F++)E[F]=$.trim(p[k.yDimension[F].dataName]),k.yDimension[F].converter&&$.isFunction(k.yDimension[F].converter)&&(E[F]=k.yDimension[F].converter.call(this,E[F],D,E));w=n(p,k.aggregates,E,w)}else 0===t&&(w=n(p,k.aggregates,null,w));e[q]=w}}else{if(F=0,t>=1){for(F=0;t>F;F++)E[F]=$.trim(p[k.yDimension[F].dataName]),k.yDimension[F].converter&&$.isFunction(k.yDimension[F].converter)&&(E[F]=k.yDimension[F].converter.call(this,E[F],D,E));v=n(p,k.aggregates,E,v)}else 0===t&&(v=n(p,k.aggregates,null,v));e.push(v)}var G,H=0,I=null,J=null;for(G in g)if(g.hasOwnProperty(G)){if(0===H)C.children&&void 0!==C.children||(C={text:G,level:0,children:[],label:G}),I=C.children;else{for(J=null,r=0;r<I.length;r++)if(I[r].text===G){J=I[r];break}J?I=J.children:(I.push({children:[],text:G,level:H,fields:g[G],label:h[G]}),I=I[I.length-1].children)}H++}y++}var K=[],L=c.length,M=L;t>0&&(j[t-1]={useColSpanStyle:!1,groupHeaders:[]}),o(C);var N;if(k.colTotals){for(var O=e.length;O--;)for(r=s;r<c.length;r++)N=c[r].name,f[N]?f[N]+=parseFloat(e[O][N]||0):f[N]=parseFloat(e[O][N]||0);if(k.colTotalsText)for(var P=0;P<k.colTotalsText.length;P++)f[k.colTotalsText[P].colName]=k.colTotalsText[P].text}if(B>0)for(r=0;B>r;r++)c[r].isGroupField&&(i.groupingView.groupField.push(c[r].name),i.groupingView.groupSummary.push(k.groupSummary),i.groupingView.groupSummaryPos.push(k.groupSummaryPos));else i.grouping=!1;i.sortname=c[B].name,i.groupingView.hideFirstGroupCol=!0}),{colModel:c,rows:e,groupOptions:i,groupHeaders:j,summary:f}},jqPivot:function(a,b,c,d){function e(a){var d,e=f.pivotSetup(a,b),g=$.assocArraySize(e.summary)>0,h=$.grid.from(e.rows);for(d=0;d<e.groupOptions.groupingView.groupField.length;d++)h.orderBy(e.groupOptions.groupingView.groupField[d],"a","text","");$.extend(!0,f.options,{data:h.select(),userData:g?e.summary:{},datatype:"local",footerrow:g,userDataOnFooter:g,colModel:e.colModel,viewrecords:!0,groupHeader:!0,groupHeaders:b.rowTotals?e.groupHeaders[1]&&e.groupHeaders[1].groupHeaders:e.groupHeaders[0]&&e.groupHeaders[0].groupHeaders,sortname:b.xDimension[0].dataName},e.groupOptions,c||{});e.groupHeaders;b.frozenStaticCols&&$(this.element).grid("setFrozenColumns")}var f=this;"string"==typeof a?$.ajax($.extend({url:data,dataType:"json",success:function(a){e($.grid.getAccessor(a,d&&d.reader?d.reader:"rows"))}},ajaxOpt||{})):e(a)}});