/*! cui 2016-11-08 */
$.component("coral.combotree",$.coral.combo,{version:"4.0.3",castProperties:["data","rootNode","buttons","shortCut"],options:{valueField:"id",textField:"name",panelRenderOnShow:!1,mode:"local",method:"post",url:null,dialogMaxHeight:500,data:null,buttons:[],postMode:"value",multiple:null,simpleDataEnable:!1,simpleDataIdKey:"id",simpleDataPIdKey:"pId",simpleDataRootPId:null,rootNode:!1,radioType:"level",showRootNode:!0,allowPushParent:!0,traversal:!1,cascadeCheck:!1,formatter:function(a){var b=$(this).combotree("option","textField");return a[b]},loader:function(a,b,c){var d=$(this),e=d.combotree("option","url");return e?void $.ajax({type:d.combotree("option","method"),url:e,data:a,dataType:"json",success:function(a){b(a)},error:function(a){c.apply(this,arguments)}}):!1},beforeClick:null,beforeLoad:$.noop,onLoad:$.noop,onError:$.noop,onSelect:$.noop,unSelect:$.noop,onExpand:null,onClick:null},tree:function(){return $("#"+$(this.element).attr("id")+"_tree")},_filterLocalTree:function(a){var b=$("#"+$(this.element).attr("id")+"_tree");b.tree("filterNodesByParam",a)},_create:function(){var a=this,b=null;this.element.addClass("coral-form-element-combotree coral-validation-combotree coral-combobox-f ctrl-form-element"),b=function(){},this.options.onShowPanel=b,this._super(),this.options.popupDialog&&(this.uiCombo.popupInputbox=this.uiCombo.popupInputbox.textbox({componentCls:"coral-combo-popup-input",icons:[{icon:"cui-icon-search2",click:function(b,c){a._filterLocalTree({name:c.value})}}],onKeyUp:function(b,c){a._filterLocalTree({name:c.value}),b.stopPropagation()}}),this.uiCombo.popupDialog.dialog({autoOpen:!1,title:"下拉树",maxHeight:"string"==typeof this.options.dialogMaxHeight?parseInt(this.options.dialogMaxHeight):this.options.dialogMaxHeight,height:"auto",width:"auto",modal:!0,resizable:!1,buttons:{"确定":function(b){var c=$.data(a.uiCombo.popupInputbox,"value"),d=$.data(a.uiCombo.popupInputbox,"text");c&&a.setValues(c,!0,d),$(this).dialog("close")},"关闭":function(a){$(this).dialog("close")}}})),this.uiCombo.panel.unbind().bind("mouseover",function(a){$(a.target).closest(".coral-combobox-item").addClass("coral-combobox-item-hover")}).bind("mouseout",function(a){$(a.target).closest(".coral-combobox-item").removeClass("coral-combobox-item-hover")}).bind("mousedown",function(b){return a.cancelBlur=!0,a._delay(function(){delete a.cancelBlur},100),!1})},_getSetting:function(){var a=this,b={simpleDataEnable:this.options.simpleDataEnable,simpleDataIdKey:this.options.simpleDataIdKey,simpleDataPIdKey:this.options.simpleDataPIdKey,simpleDataRootPId:this.options.simpleDataRootPId,checkable:null==this.options.multiple?this.options.checkable:this.options.multiple,chkStyle:this.options.chkStyle,radioType:this.options.radioType,showRootNode:this.options.showRootNode,rootNode:this.options.rootNode,chkboxType:this.options.cascadeCheck?{Y:"",N:""}:{Y:"ps",N:"ps"},beforeClick:function(b,c){if(!a.options.allowPushParent&&c.isParent)return!1;var d=$.coral.toFunction(a.options.beforeClick);return a.options.multiple?!1:a.options.checkable?!1:$.isFunction(d)?d(b,c):!0},onClick:function(b,c,d,e){var f=[],g=[];if(f.push(d.name),g.push(d.id),a.options.traversal)for(var h=d.getParentNode();h;)f.push(h.name),h=h.getParentNode();return a.options.popupDialog?($.data(a.uiCombo.popupInputbox,"value",g.reverse()),$.data(a.uiCombo.popupInputbox,"text",f.reverse())):a.setValues(g.reverse(),!0,f.reverse()),(!a.options.multiple&&!d.isParent||!a.options.multiple&&a.options.allowPushParent)&&a.hidePanel(),a._trigger("onNodeClick",b,{treeId:c,node:d,treeNode:d,clickFlag:e}),!1},beforeCheck:function(b,c){var d=a._trigger("beforeNodeCheck",null,{treeId:b,node:c});return d?void 0:!1},onCheck:function(b,c,d){for(var e=[],f=[],g=$("#"+c).tree("getCheckedNodes",!0),h=0,i=g.length;i>h;h++)if(a.options.cascadeCheck||!g[h].getCheckStatus().half){if(!a.options.allowPushParent&&g[h].isParent)continue;e.push(g[h].name),f.push(g[h].id)}a.options.popupDialog?($.data(a.uiCombo.popupInputbox,"value",f),$.data(a.uiCombo.popupInputbox,"text",e)):a.setValues(f,!0,e),a._trigger("onNodeCheck",b,{treeId:c,node:d})},onLoad:function(b,c,d,e){var f,g=[],h=[],i=[],j=!1,k=$("#"+c),m=k.tree("getNodes"),n=k.tree("transformToArray",m);if(a.options.clearOnLoad&&(j=a._clearValues(n)),1==k.tree("option","checkable")){for(i=k.tree("getCheckedNodes",!0),f=0,l=i.length;f<l;f++)if(a.options.cascadeCheck||!i[f].getCheckStatus().half){if(!a.options.allowPushParent&&i[f].isParent)continue;g.push(i[f].name),h.push(i[f].id)}}else g=!1;a.currentValues.length&&!j&&(h=a.currentValues),a.isInit||(a.isInit=!0,a.originalValue=h.join(",")),a.isLoaded=!0,a.dataLoaded=!0,a.setValues(h,!1,g),a._trigger("onLoad",b,{treeId:c,treeNode:d,msg:e})},onExpand:function(b,c,d){a._trigger("onExpand",b,[{treeId:c,node:d}])}};return b},setPopupInput:function(a){this.uiCombo.popupInputbox.textbox("setValue",a.join(this.options.separator))},_initData:function(){var a=$('<ul id="'+$(this.element).attr("id")+'_tree"></ul>');this.options.popupDialog?(a.appendTo(this.uiCombo.popupDialog),this.uiCombo.popupDialogTree=a):a.appendTo(this.uiCombo.pContent),this.uiCombo.panel.unbind().bind("mousedown",function(a){a.preventDefault()});var b=this._getSetting();"string"==typeof this.options.url&&""!==this.options.url&&$.extend(b,{asyncEnable:!0,asyncUrl:this.options.url,asyncAutoParam:"id,name"}),a.tree(b,this.options.data)},_renderItems:function(a){},_scrollTo:function(a){var b=this.panel(),c=b.find('div.coral-combobox-item[value="'+a+'"]');if(c.length)if(c.position().top<=0){var d=b.scrollTop()+c.position().top;b.scrollTop(d)}else if(c.position().top+c.outerHeight()>b.height()){var d=b.scrollTop()+c.position().top+c.outerHeight()-b.height();b.scrollTop(d)}},_request:function(a,b,c){var d=this,e={},f=[],g=this.options.loader,h=!1;if(a||d.options.url?!a&&d.options.url&&(a=d.options.url):a=[],"string"!=typeof a?(e=a,e.data?f=e.data:e.url?(a=e.url,d.options.url=e.url,h=!0):e instanceof Array?f=a:e.url||e.data||d.options.url?e.url||e.data||!d.options.url||(a=d.options.url,h=!0):f=[]):(d.options.url=a,h=!0),h){if(b=b||{},0==this._trigger("beforeLoad",null,[b]))return;g.apply(this.element,[b,function(a){d.loadData(a,c),d._trigger($.isFunction(e.onLoad)?e.onLoad:"onLoad",null,[a])},function(){d._trigger("onError",null,arguments)}])}else d.loadData(f,c),d._trigger($.isFunction(e.onLoad)?e.onLoad:"onLoad",null,[f])},getTree:function(){return $("#"+$(this.element).attr("id")+"_tree")},loadData:function(a,b){var c=this.getTree();c.tree("reload",a);var d=c.tree("getNodes");$.each(d,function(a,b){c.tree("expandNode",b,!0)}),this.dataLoaded=!0,this.setValues(this.currentValues)},getData:function(){return this.getTree().tree("getNodes")||[]},setComboValues:function(a,b){this.setValues(a,!1,b)},_setTreeNodeState:function(a,b){var c=this.options,d=[],e=$("#"+$(this.element).attr("id")+"_tree");if(e.tree("cancelSelectedNode"),1==e.tree("option","checkable")){e.tree("checkAllNodes",!1);for(i in a){var f=e.tree("getNodeByParam","id",a[i]);f&&e.tree("checkNode",f,!0,!c.cascadeCheck),b||(f?d.push(f.name):d.push(a[i]))}}else for(i in a){var f=e.tree("getNodeByParam","id",a[i]);e.tree("selectNode",f),b||(f?d.push(f.name):d.push(a[i]))}return b||(b=d),b},setValues:function(a,b,c){var d;this.currentValues=a,d=this._setTreeNodeState(a,c).join(this.options.separator),c="boolean"==typeof c?c:!1,c||this._setText(d),this._super(a,b,c)},setValue:function(a,b,c){a=a.split(this.options.separator),this.setValues(a,!1,c)},_getOnlyValues:function(){var a=(this.getData(),this.options),b=[],c=0;if(!this.currentValues||!this.currentValues[0]&&1===this.currentValues.length)return b;for(;c<this.currentValues.length;c++){var d=this.currentValues[c];"value"===a.postMode&&b.push(d)}return b},_showItems:function(){var a=this.tree().tree("getNodes"),b=this.tree().tree("transformToArray",a);this.tree().tree("showNodes",b,{showParents:!0})},_doQuery:function(a){if(""!=a){var b=this.options,c=[],d=b.textField,e=b.valueField,f=this.options.filter;if("remote"==b.mode)this._request(null,{q:a},!0);else{var g=this.tree().tree("getNodes"),h=this.tree().tree("transformToArray",g);this.tree().tree("hideNodes",h);for(var i=0;i<h.length;i++)for(var j=pinyinEngine.toPinyin(h[i][d],!1,""),k=0;k<a.length;k++){var l=f.apply(this.element,[a[k],h[i]]);if(l){var m=(h[i][e],h[i][d]);(m.indexOf(a[k])>-1||j.indexOf(a[k])>-1)&&(c.push(h[i]),this.tree().tree("showNodes",c,{showParents:!0}),this.tree().tree("expandNode",c[0].getParentNode(),!0,!1,!1))}}}}},_checkMathch:function(a,b){var c,d,e,f,g=[],h=[],i=[],j=this.options,k=j.textField,m=j.valueField;b&&this._showItems();var n=!1,o={};if(j.multiple){for(this.tree().tree("checkAllNodes",!1),c=0;c<a.length;c++)if(!b||!this.options.forceSelection||""!==$.trim(a[c])){var i=this.tree().tree("getNodesByParam",k,a[c],null);for(i.length||(o[c.toString()]=!0),d=0;d<i.length;d++)if(j.cascadeCheck||!i[d].isParent){g.push(i[d][m]),h.push(i[d][k]),n=!0;break}n||this.options.forceSelection||(!o[c.toString()]&&!b||b)&&(g.push(a[c]),h.push(a[c])),n=!1}for(f=0;f<g.length;f++){var i=this.tree().tree("getNodesByParam",m,g[f],null);i.length&&this.tree().tree("checkNode",i[0],!0,!j.cascadeCheck)}var i=this.tree().tree("getCheckedNodes",!0);for(e=0,l=i.length;e<l;e++)if(j.cascadeCheck||!i[e].getCheckStatus().half){if(!j.allowPushParent&&i[e].isParent)continue;-1==$.inArray(i[e][m],g)&&(h.push(i[e][k]),g.push(i[e][m]))}}else{var i=this.tree().tree("getNodesByParam",k,a[0],null),p=-1;for(c=0;c<i.length;c++)p=-1===p?c:p,n=!0;n&&(g.push(i[p][m]),h.push(i[p][k])),n||this.options.forceSelection||(g.push(a[0]),h.push(a[0]))}return{valarr:g,textarr:h}},clear:function(){this._super(),this.options.multiple&&$("#"+$(this.element).attr("id")+"_tree").tree("checkAllNodes",!1)},_formatValue:function(a){var b;b=this.options.multiple?this.getTree().tree("getCheckedNodes",!0):this.getTree().tree("getSelectedNodes");var c=this.options,d=c.valueField,e=c.textField,f=0,g=null;if("text"===c.postMode||"value-text"===c.postMode)for(f=0;f<b.length;f++)if(g=b[f],""!=a&&a==g[d]){if("text"===c.postMode)return g[e];if("value-text"===c.postMode)return a+c.valueTextSeparator+g[e]}return a},reload:function(a){this._request(a)},_destroy:function(){this.element.removeClass("coral-validation-combotree"),this.element.removeClass("coral-form-element-combotree"),this.options.popupDialog&&this.uiCombo.popupDialog.dialog("forceDestroy"),this._super()}});