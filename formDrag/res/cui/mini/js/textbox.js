/*! cui 2016-11-08 */
$.component("coral.textbox",$.coral.inputbase,{version:$.coral.version,castProperties:["dataCustom","title","buttons","buttonOptions","triggers","showRequiredMark","hideRequiredMark","formatterText","valid","onValidSuccess","onValidError"],options:{swfPath:$.coral.contextPath+"/jquery-cui/resource/swfupload.swf",hasTips:!1,showStar:!0,showClose:!1,dataCustom:null,autoDecode:!1,value:"",readonly:!1,readonlyInput:!1,disabled:!1,required:!1,isLabel:!1,title:null,buttons:[],useHiddenInput:!0,errMsg:null,errMsgPosition:"leftBottom",placeholder:"",type:"text",labelField:null,starBefore:!1,valueChangedOnKeyUp:!1,delSpace:!1,onClick:null,onChange:null,onBlur:null,onFocus:null,onKeyDown:null,onKeyUp:null,onKeyPress:null,onEnter:null,onMouseEnter:null,onMouseLeave:null,onCreate:null,onValidSuccess:null,onValidError:null,onValidWarn:null,onUploadSuccess:null,buttonOptions:null,triggers:null,excluded:!1},button:function(){return null!==this.options.buttonOptions?this.$button:void 0},component:function(){return this.textboxWrapper},focus:function(){if(this.options.disabled||this.options.isLabel||this.options.readonly||this.options.readonlyInput)return!1;if("hidden"!=this.element.attr("type")){return this.element.focus(),!0}},_create:function(){var a=this;a.options.hasTips&&(a.options.title=!0),this._initElement(),this.options.dataCustom&&this.element.attr("data-custom",this.options.dataCustom),this.setValue(this.element.val(),!1),this.originalValue=this.getValue(),this._bindEvents(),null!==this.options.buttonOptions&&this._outerButtons(),a._trigger("onCreate",null,[])},_getButtonEl:function(){return $("<button type='button'></button>").addClass("coral-textbox-button")},reset:function(){this.setValue(this.originalValue)},_initSimple:function(){var a=this;a.element.uniqueId().attr("id")},_initUpload:function(){var a=this,b=a.element.uniqueId().attr("id");a.select=[],$(this.element).wrap('<span class="coral-file-default"></span>').before("<span class='coral-file'>请选择...</span>").before("<div id='"+b+"_upload'></div>").before("<div id='"+b+"_queue'></div>").hide(),a.uploader=$("#"+b+"_upload"),a.uploader.uploadify({swf:this.options.swfPath,uploader:a.options.uploadUrl,queueID:b+"_queue",height:"28",width:"800",buttonText:"浏览",onDialogOpen:function(){a.select=[]},onDialogClose:function(){},onSelect:function(b){a.select.push(b.name),a.textboxWrapper.find(".coral-file").html(a.select.join(",")),a.textboxWrapper.find("object").attr("title",a.select.join(","))},onCancel:function(a){},onQueueComplete:function(c){setTimeout(function(){$("#"+b+"_queue").dialog("close"),a.select=[]},3500)},onUploadSuccess:function(b,c,d){a._trigger("onUploadSuccess",null,[{file:b,data:c,response:d}])},auto:!1}),$("#"+b+"_queue").dialog({autoOpen:!1,modal:!1,resizable:!1,onOpen:function(){a.uploader.uploadify("upload","*")}})},upload:function(a){var b=this,c=b.element[0].id;0!==this.select.length&&$("#"+c+"_queue").dialog("open")},cancel:function(a){this.uploader.uploadify("cancel")},clear:function(a){this.select=[],this.textboxWrapper.find(".coral-file").html("请选择..."),this.textboxWrapper.find("object").attr("title","请选择..."),this.uploader.uploadify("cancel")},_getIcon:function(a){var b=[];if("undefined"==typeof a||null==a||""==a)return[];if("object"==typeof a)for(var c in a){var d={};d[a[c].icon]=a[c].click,b.push(d)}else{var e=$.trim(a).split(",");for(var c in e){var f=e[c].split(" "),d={};d[f[0]]=f[1],b.push(d)}}return b},_triggerClick:function(a,b,c){var d=this,e=null,f=this.options;if(b=$.Event(b),f.controllerName){var g=$.controller(f.controllerName);return e=g[a],e.apply(g,[b].concat(c))}return e=$.coral.toFunction(a),e.apply(d.element[0],[b].concat(c))},_updateLabel:function(a){this.uiLabel.html(a)},_initElement:function(){var a=this,b=a.options;if(this.className="coral-textbox-default coral-validation-textbox tabbable "+this.element[0].className,this.compClass="coral-textbox",this.hiddenClass="",this.classBorder="","hidden"==this.element.attr("type")&&(this.compClass=this.compClass+" hide"),"TEXTAREA"==this.element[0].tagName&&(this.compClass="coral-textbox coral-textbox-textarea"),this.createInput(),this.textboxWrapper=$(this.textboxWrapper),this.elementBorder=$(this.elementBorder),this.element=$(this.textboxInput),this.options.useHiddenInput?this.textboxHidden=$(this.textboxWrapper[0].lastChild):this.textboxHidden=this.element,this.options.buttons.length>0&&this._createButtonPanel(),b.labelField&&(this.uiLabel=$('<label class="coral-label">'+b.labelField+"</label>"),this.elementBorder.before(this.uiLabel),this.textboxWrapper.addClass("coral-hasLabel"),this._createLabel()),"file"==a.element.attr("type")&&("uploadify"==a.options.formatter&&a._initUpload(),"simple"!=a.options.formatter&&"undefined"!=typeof a.options.formatter||a._initSimple()),a.options.icons){var c=[],d=null;if(0!=(c=a._getIcon(a.options.icons)).length?d=!0:0!=(c=a._getIcon(a.options.texticons)).length&&(d=!1),null!=d){this.uiDialogButtonPanel=$('<span class="coral-textbox-btn-icons coral-corner-right"></span>'),a.elementBorder.append(this.uiDialogButtonPanel);for(var e in c)$.each(c[e],function(b,c){var e=$('<span class="coral-textbox-btn-ico icon"></span>');d?e.addClass(b):e.addClass("coral-textbox-btn-textico").html(b),e.bind("click"+a.eventNamespace,function(b){a.options.disabled||a._triggerClick(c,b,[{value:a.element.val()}])}),a.uiDialogButtonPanel.append(e)});this.rightPos=this.uiDialogButtonPanel.outerWidth()}}return"undefined"!=typeof this.element.attr("name")?this.options.name=this.element.attr("name"):this.options.name&&this.element.attr("name",this.options.name),"TEXTAREA"===this.element[0].tagName?""!==$.trim(this.element.text())?this.options.value=this.element.text():this.options.value&&this.element.text(this.options.value):""!==$.trim(this.element.val())?this.options.value=this.element.val():this.options.value&&this.element.val(this.options.value),b.width&&this.textboxWrapper.css("width",b.width),b.height&&this._setOption("height",b.height),b.readonlyInput&&this._setReadonlyInput(),b.readonly&&this._setReadonly(),"boolean"==typeof b.isLabel&&b.isLabel?(this._setReadonly(),this.options.readonly=!0,void this.component().addClass("coral-isLabel")):("boolean"==typeof b.disabled&&b.disabled&&this._setOption("disabled",b.disabled),this.options.showClose&&this.clearIcon.css("right",this.rightPos?this.rightPos:0),this.element.attr("placeholder",b.placeholder),b.placeholder&&""===this.element.val()&&this._showPlaceholder(),void this._updateTitle())},_setReadonlyInput:function(){"undefined"!=typeof this.element.attr("readonly")?this.options.readonlyInput=this.element.prop("readonly"):this.options.readonlyInput&&this.element.prop("readonly",this.options.readonlyInput),this.element.prop("readonly")&&this.component().addClass("coral-readonlyInput")},_setReadonly:function(){this.options.readonlyInput=!0,this._setReadonlyInput(),this.component().removeClass("coral-readonlyInput").addClass("coral-readonly"),this.element.removeClass("tabbable")},_updateTitle:function(){var a=this,b=this.options;1==b.title?a.element.attr("title",a.element.val()):0==b.title?a.element.attr("title",""):a.element.attr("title",b.title)},_showPlaceholder:function(){if(!$.support.placeholder){var a=this,b=$("<span class='coral-textbox-placeholder-label'>"+a.options.placeholder+"</span>");$(a.element).after(b)}},_hidePlaceholder:function(){if(!$.support.placeholder){var a=this;a.textboxWrapper.find(".coral-textbox-placeholder-label").remove()}},_bindEvents:function(){var a,b=this,c=this.options;coral.eventsQueue.push({instance:this,args:[{"mouseenter.coral-textbox-border":function(a){"boolean"==typeof c.isLabel&&c.isLabel||"boolean"==typeof c.readonly&&c.readonly||(b.component().addClass("coral-textbox-hover"),this._trigger("onMouseEnter",a,[]))},"mouseleave.coral-textbox-border":function(a){"boolean"==typeof c.isLabel&&c.isLabel||"boolean"==typeof c.readonly&&c.readonly||(b.component().removeClass("coral-textbox-hover"),this._trigger("onMouseLeave",a,[]))},click:function(a){b._hidePlaceholder(),this._trigger("onClick",a,[])},"click.coral-textbox-placeholder-label":function(a){b._hidePlaceholder(),b.element.focus()},dblclick:function(a){this._trigger("onDblClick",a,[])},blur:function(b){return this.component().removeClass("coral-state-focus"),""===this.element.val()&&this._showPlaceholder(),a?void(a=!1):(this._setValue(this.element.val(),!0),void this._trigger("onBlur",b,[]))},focusin:function(a){return c.isLabel||c.readonly||c.readonlyInput?void this._trigger("onFocus",a,[{value:this.textboxHidden.val(),text:this.element.val()}]):(this.options.formatterText&&this.setText(this.getValue()),this.component().addClass("coral-state-focus"),void this._trigger("onFocus",a,[{value:this.textboxHidden.val(),text:this.element.val()}]))},keydown:function(a){if(!(c.isLabel||c.readonly||c.readonlyInput)){$.validate.restrictInput(this.element,a),c.shortCut&&$.coral.callFunction(c.shortCut,a,this);var b=this._trigger("onKeyDown",a,[{value:this.textboxHidden.val(),text:this.element.val(),id:this.options.id}]);return 13==a.keyCode&&(this._setValue(this.element.val(),!0),this._trigger("onEnter",a,[{value:this.textboxHidden.val(),text:this.element.val()}])),this._hidePlaceholder(),b}},keypress:function(a){return c.isLabel||c.readonly||c.readonlyInput?void 0:this._trigger("onKeyPress",a,[{value:this.textboxHidden.val(),text:this.element.val()}])},keyup:function(a){c.isLabel||c.readonly||c.readonlyInput||(this.options.valueChangedOnKeyUp&&this._setValue(this.element.val(),!0,!1),$.validate.restrictInput(this.element,a),this._trigger("onKeyUp",a,[{value:this.textboxHidden.val(),text:this.element.val(),id:this.options.id}]))},"click.coral-input-clearIcon":function(a){a.preventDefault(),this.setValue("",!0),this.options.placeholder&&this._showPlaceholder(),this._trigger("onCloseClick",event,[])},"mousedown.coral-input-clearIcon":function(b){b.stopPropagation(),a=!0}}]}),coral.eventsTimer||(coral.eventsTimer=setTimeout(function(){coral.eventsParser()},50))},_setOption:function(a,b){var c=this;if("id"!==a&&"name"!==a&&"type"!==a){if("height"===a&&b&&(this.component().outerHeight(b),this.textboxWrapper.find(".coral-textbox-btn-textico").css({"line-height":b-6+"px",height:b+"px"})),"width"===a&&b&&this.component().outerWidth(b),this._super(a,b),"placeholder"===a&&(this.element.attr("placeholder",this.options.placeholder),""===this.getValue()&&this._showPlaceholder()),"texticons"==a){var d=c._getIcon(c.options.texticons),e=$('<span class="coral-textbox-btn-icons coral-corner-right"></span>');c.elementBorder.find(".coral-textbox-btn-icons").replaceWith(e);for(var f in d)$.each(d[f],function(a,b){var d=$('<span class="coral-textbox-btn-ico icon"></span>').addClass("coral-textbox-btn-textico").html(a);d.bind("click"+c.eventNamespace,function(a){c.options.disabled||c._triggerClick(b,a,[{value:c.element.val()}])}),e.append(d)})}"value"===a&&(c._updateTitle(),c.setValue(b,!1)),"isLabel"===a&&("boolean"==typeof b&&b?(this._setReadonly(),this.component().removeClass("coral-readonly").addClass("coral-isLabel")):"boolean"!=typeof b||b||(this.element.prop("readonly",!1),this.options.readonly=!1,this.options.isLabel=!1,this.options.readonlyInput=!1,this.element.addClass("tabbable"),this.component().removeClass("coral-isLabel coral-readonly"))),"readonly"===a&&("boolean"==typeof b&&b?(this._setReadonly(),this.component().removeClass("coral-isLabel").addClass("coral-readonly")):"boolean"!=typeof b||b||(this.element.prop("readonly",!1),this.options.readonly=!1,this.options.readonlyInput=!1,this.element.prop("readonly",!1),this.element.addClass("tabbable"),this.component().removeClass("coral-isLabel coral-readonly"))),"readonlyInput"===a&&("boolean"==typeof b&&b?(this._setReadonlyInput(),this.component().removeClass("coral-isLabel").addClass("coral-readonlyInput")):"boolean"!=typeof b||b||(this.element.prop("readonly",!1),this.options.readonlyInput=!1,this.component().removeClass("coral-isLabel coral-readonlyInput"))),"disabled"===a&&(b?this.element.prop("disabled",!0):this.element.prop("disabled",!1)),"labelField"===a&&c._updateLabel(b),"title"===a&&c._updateTitle(),"hasTips"===a&&c._updateTitle()}},_destroy:function(){this.textboxWrapper.replaceWith(this.element),this.element.val(""),this.element.removeAttr("value"),this.element.removeClass("coral-textbox-default").removeClass("coral-validation-textbox").removeClass("coral-textbox-hover").removeClass("coral-textbox-textarea").removeClass("coral-textbox-input").removeAttr("placeholder").removeAttr("title").removeAttr("readonly").removeAttr("disabled")},disable:function(){this._setOption("disabled",!0)},enable:function(){this._setOption("disabled",!1)},getHtml:function(){return this.element.text()},setHtml:function(){this.element.text(value),this._updateTitle()},getValue:function(){var a=this.textboxHidden.val();return this.options.autoDecode&&(a=$.coral.decode(a)),this.options.delSpace&&(a=a.trim()),a},getValidateValue:function(){return this.getText()},getText:function(){return this.component().hasClass("coral-state-focus")?this.element.val():this.textboxHidden.val()},_setValue:function(a,b,c){a=null===a||"undefined"==typeof a?"":a;var d=a;c=c!==!1;var e=$.coral.toFunction(this.options.formatterText);$.isFunction(e)&&(d=e.apply(this.options.element,[{value:a}])),c&&this.setText(d),this.textboxHidden.val(a),this.options.value=a,b&&this.previous!=a&&this._trigger("onChange",null,[{value:a,text:d}]),this.previous=a,""!==a&&this._hidePlaceholder()},setValue:function(a,b,c){a=null===a||"undefined"==typeof a?"":a,this.options.autoDecode&&(a=$.coral.encode(a)),this._setValue(a,b,c)},setText:function(a){this.element.is("textarea")?(this.element.val(a),this.element.text(a)):this.element.val(a),this._updateTitle()},formValue:function(){var a={},b=this.element.attr("name");return b?(a[b]=this.getValue(),a):null}});