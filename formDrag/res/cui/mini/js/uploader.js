/*! cui 2016-11-08 */
$.component("coral.uploader",{version:$.coral.version,castProperties:["dataCustom","formData","overrideEvents","buttons","itemTemplate"],options:{id:"",swf:$.coral.scriptPath+"external/swfupload.swf",uploader:"",auto:!0,buttonClass:"",buttonCursor:"hand",buttonImage:null,buttonText:"SELECT FILES",checkExisting:!1,debug:!1,fileObjName:"Filedata",fileSizeLimit:0,fileTypeDesc:"All Files",fileTypeExts:"*.*",heigh:30,itemTemplate:!1,method:"post",multi:!0,formData:{},preventCaching:!0,progressData:"percentage",queueID:!1,queueSizeLimit:999,removeCompleted:!0,removeTimeout:3,requeueError:!1,successTimeout:30,uploadLimit:0,width:120,cls:"",displayStyle:"original",emptyText:"请选择...",delay:1e3,buttons:null,overrideEvents:[],onCancel:null,onClearQueue:null,onDestroy:null,onDialogClose:null,onDialogOpen:null,onDisable:null,onEnable:null,onFallback:null,onNoflash:null,onInit:null,onQueueComplete:null,onSelectError:null,onSelect:null,onNoFlash:null,onSWFReady:null,onUploadComplete:null,onUploadError:null,onUploadSuccess:null,onUploadProgress:null,onUploadStart:null},_create:function(){var a=this;a._initElement();var b=a._flashCheck();0==b&&a._trigger("onNoFlash",null,[])},_initElement:function(){var a=this,b=a.options,c={};"undefined"!=typeof a.element.attr("id")?b.id=a.element.attr("id"):b.id&&a.element.attr("id",b.id),"undefined"!=typeof a.element.attr("name")?b.name=a.element.attr("name"):b.name&&a.element.attr("name",b.name),delete b.id,c=a.getEventsObj(),b=$.extend({},b,c),this._initUploder(b),b.id=a.element.attr("id")},_flashCheck:function(){var a=!-[1],b=!0;if(a)try{new ActiveXObject("ShockwaveFlash.ShockwaveFlash");b=!0}catch(c){b=!1}else try{if(navigator.plugins&&navigator.plugins.length>0){var d=navigator.plugins["Shockwave Flash"];void 0==d&&(b=!1)}else b=!0}catch(c){b=!1}return b},component:function(){return this.uiUploader},destroy:function(){this.uploader.uploadify("destroy")},disable:function(a){this.uploader.uploadify("disable",a)},settings:function(a,b,c){this.uploader.uploadify("settings",a,b,c)},stop:function(){this.uploader.uploadify("stop")},upload:function(a){if("original"==this.options.displayStyle||!this._isQueueDialog())return void this.uploader.uploadify("upload",a);if(0!=this.select.length){var b=this.element.attr("id");$("#"+b+"_queue").dialog("open")}},getvalue:function(){return 0==this.select.length&&alert("none file"),this.select.join(",")},cancel:function(){this.uploader.uploadify("cancel")},clear:function(a){"custom"==this.options.displayStyle&&(this.select=[],this.uiUploader.find(".coral-file").html("请选择..."),this.uiUploader.find("object").attr("title","请选择...")),this.uploader.uploadify("cancel"),this.clearQueue()},clearQueue:function(){this.uploader.clearQueue()},uploadify:function(){return this.uploader},queueData:function(){return this.uploader.data("uploadify").queueData},_getButtons:function(){if("object"==typeof this.options.buttons)return this.options.buttons;if("string"!=typeof this.options.buttons)return[];var a=(this.options,this.options.buttons),b=[],c=$.trim(a).split(",");for(var d in c){var e={},f=c[d].split(" ");e.label=f[0],e.click=f[1],b.push(e)}return b},_triggerClick:function(a,b,c){var d=this,e=$.coral.toFunction(a);return b=$.Event(b),e.apply(d.element[0],[b].concat(c))},_createButtons:function(){var a=this,b=(this.options,this._getButtons()),c=$('<span class="coral-uploader-btn-icons coral-corner-right"></span>');a.uiBorder.append(c),$.each(b,function(b,d){var e=d.label,f=d.id,g=d.click,h={},i=$('<span class="coral-uploader-btn-ico icon coral-uploader-btn-textico"></span>');e&&(i.html(e),h.label=e),f&&(i.attr("data-id",f),h.id=f),i.bind("click"+a.eventNamespace,function(b){a.options.disabled||a._triggerClick(g,b,h)}),c.append(i)})},_initUploder:function(a){var b=this,c=b.element.attr("id");if(b.uiUploader=$('<span class="coral-uploader"></span>'),b.uiBorder=$('<span class="coral-uploader-border coral-corner-all"></span>'),b.uploader=$('<div id="'+c+'_uploader"></div>'),b.element.after(b.uiUploader),b.uiUploader.append(b.uiBorder),b.uiBorder.append(b.element),b.element.hide(),"original"==a.displayStyle)return b.element.before(b.uploader),void this.uploader.uploadify(a);this.uiUploader.addClass("coral-uploader-custom coral-textbox"),this.uiBorder.addClass("coral-textbox-border"),a.buttons&&this._createButtons(),b.select=[],$(this.element).wrap('<span class="coral-file-default"></span>').before("<span class='coral-file'>"+a.emptyText+"</span>").before(b.uploader);var d=$.extend(a,{height:28,width:800});d.queueID||($(this.element).before("<div id='"+c+"_queue'></div>"),$("#"+c+"_queue").dialog({autoOpen:!1,title:"上传",modal:!1,resizable:!1,onOpen:function(){b.uploader.uploadify("upload","*")}}),a.queueID=c+"_queue",this.hasDialog=!0),b.uploader.uploadify(d)},_isQueueDialog:function(){return this.hasDialog},_reloadUploader:function(){var a=this,b=this.options;delete b.id,a.uploader.uploadify(b),b.id=a.element.attr("id")},getEventsObj:function(){var a=this,b=this.options,c=this.element.attr("id");return{onCancel:function(b){a._trigger("onCancel",null,[{file:b}])},onClearQueue:function(b){a._trigger("onClearQueue",null,[{queueItemCount:b}])},onDestroy:function(){a._trigger("onDestroy",null,[])},onDialogClose:function(d){"custom"==b.displayStyle&&b.auto&&a._isQueueDialog()&&$("#"+c+"_queue").dialog("open"),a._trigger("onDialogClose",null,[{queueData:d}])},onDialogOpen:function(){"custom"==b.displayStyle,a._trigger("onDialogOpen",null,[])},onDisable:function(){a._trigger("onDisable",null,[])},onEnable:function(){a._trigger("onEnable",null,[])},onFallback:function(){a._trigger("onFallback ",null,[])},onNoflash:function(){return a.uiBorder},onInit:function(b){a._trigger("onInit",null,[{swfuploadify:b}])},onQueueComplete:function(c){var d=a.element.attr("id");"custom"==b.displayStyle&&a._isQueueDialog()&&setTimeout(function(){$("#"+d+"_queue").dialog("close"),a.select=[]},b.delay),a._trigger("onQueueComplete",null,[{queueData:c}])},onSelectError:function(b,c,d){a._trigger("onSelectError",null,[{arguments:arguments}])},onSelect:function(c){"custom"==b.displayStyle&&(a.select.push(c.name),a.uiUploader.find(".coral-file").html(a.select.join(",")),a.uiUploader.find("object").attr("title",a.select.join(","))),a._trigger("onSelect",null,[{file:c}])},onSWFReady:function(){a._trigger("onSWFReady",null,[])},onUploadComplete:function(b){a._trigger("onUploadComplete",null,[{file:b}])},onUploadError:function(b,c,d,e){a._trigger("onUploadError",null,[{file:b,errorCode:c,errorMsg:d,errorString:e}])},onUploadSuccess:function(b,c,d){a._trigger("onUploadSuccess",null,[{file:b,data:c,response:d}])},onUploadProgress:function(b,c,d,e,f){a._trigger("onUploadProgress",null,[{file:b,fileBytesLoaded:c,fileTotalBytes:d,queueBytesLoaded:e,uploadSize:f}])},onUploadStart:function(b){a._trigger("onUploadStart",null,[{file:b}])}}},_setOption:function(a,b){var c=this;if("id"!==a&&"name"!==a)return this._super(a,b),"emptyText"===a?void this.uiUploader.find(".coral-file").html(b):void c.settings(a,b)},_destroy:function(){var a=this;a.uiUploader.replaceWith(a.element)}});